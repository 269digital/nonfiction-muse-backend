<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-fiction Muse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .project-setup {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .target-length {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .target-length input {
            flex: 1;
        }

        .target-length select {
            flex: 0 0 120px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .chapters-container {
            margin-top: 20px;
        }

        .export-section {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-left-color: #4facfe;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 15px 25px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border: none;
        }

        .export-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .copy-content {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .target-length {
                flex-direction: column;
            }
            
            .target-length select {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Non-Fiction Muse</h1>
            <p>Your AI-powered book writing companion</p>
        </div>

        <div class="main-content">
            <!-- Project Setup -->
            <div class="section project-setup">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><span class="section-icon">üéØ</span>Project Setup</h2>
                    <button class="btn" onclick="startNewProject()" style="background: #dc3545; font-size: 14px; padding: 8px 16px;">
                        üÜï New Project
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="bookTitle">Book Title *</label>
                    <input type="text" id="bookTitle" placeholder="Enter your book title..." oninput="updateProject()">
                </div>

                <div class="form-group">
                    <label for="bookDescription">Book Description *</label>
                    <textarea id="bookDescription" placeholder="Describe what your book is about, who it's for, and what value it provides..." oninput="updateProject()"></textarea>
                </div>

                <div class="form-group">
                    <label for="targetLength">Target Length *</label>
                    <div class="target-length">
                        <input type="number" id="targetLength" placeholder="Enter target..." min="1" oninput="updateProject()">
                        <select id="targetUnit" onchange="updateProject()">
                            <option value="words">Words</option>
                            <option value="pages">Pages</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Research Upload -->
            <div class="section">
                <h2><span class="section-icon">üìÑ</span>Research Documents</h2>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <p>üìÅ Click to upload research documents (PDF, TXT, DOCX)</p>
                    <p><small>Or drag and drop files here</small></p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.docx" style="display: none;" onchange="handleFileUpload(event)">
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="researchNotes">Research Notes</label>
                    <textarea id="researchNotes" placeholder="Add your research notes, key points, references, or any important information for your book..." oninput="updateProject()"></textarea>
                </div>
            </div>

            <!-- Outline Generation -->
            <div class="section">
                <h2><span class="section-icon">üìã</span>Book Outline</h2>
                <button class="btn" id="generateOutlineBtn" onclick="generateOutline()">‚ú® Generate Outline with AI</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="outlineContent">Book Outline</label>
                    <textarea id="outlineContent" placeholder="Your book outline will appear here, or you can write your own..." oninput="updateProject()" style="min-height: 200px;"></textarea>
                </div>

                <button class="btn btn-secondary" onclick="parseChaptersFromOutline()" style="margin-top: 10px;">
                    üìö Convert Outline to Chapters
                </button>
            </div>

            <!-- Chapter Management -->
            <div class="section">
                <h2><span class="section-icon">üìñ</span>Chapters</h2>

                <div id="chaptersContainer" class="chapters-container">
                    <!-- Chapters will be rendered here -->
                </div>
            </div>

            <!-- Export Section -->
            <div class="section export-section">
                <h2><span class="section-icon">üíæ</span>Export Manuscript</h2>
                <p><strong>üìñ Copy & Paste to Word:</strong></p>
                
                <div class="export-buttons">
                    <button class="export-btn export-btn-primary" onclick="showWordExport()">
                        üìÑ Copy Content for Word Document
                    </button>
                    
                    <button class="export-btn export-btn-success" onclick="showChapterExport()">
                        üìö Copy Individual Chapters for Atticus
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                    <h3>üìã How to Create Word Documents:</h3>
                    <ol style="margin-top: 10px; padding-left: 20px;">
                        <li><strong>Click export button above</strong> ‚Üí Content appears in popup</li>
                        <li><strong>Click "Copy to Clipboard"</strong> ‚Üí Content copied</li>
                        <li><strong>Open Microsoft Word</strong> ‚Üí Create new document</li>
                        <li><strong>Paste content</strong> (Ctrl+V) ‚Üí Format as needed</li>
                        <li><strong>Save as .docx file</strong> ‚Üí Import into Atticus</li>
                    </ol>
                    <p style="margin-top: 10px;"><small>‚úÖ This method is 100% reliable and works without external libraries!</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Export Content</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global project state
        let currentProject = {
            title: '',
            description: '',
            targetLength: 50000,
            targetUnit: 'words',
            researchNotes: '',
            outline: '',
            chapters: []
        };

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            // Check for new project parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('new') === '1') {
                localStorage.removeItem('nonfictionMuse_project');
                // Clear URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            loadProject();
            renderChapters();
        });

        // File upload handling
        document.addEventListener('DOMContentLoaded', function() {
            const fileUpload = document.querySelector('.file-upload');
            
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFileUpload({ target: { files } });
            });
        });

        function handleFileUpload(event) {
            const files = event.target.files;
            let processedContent = '';
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processedContent += `\n\n--- ${file.name} ---\n`;
                    processedContent += e.target.result;
                    
                    const currentNotes = document.getElementById('researchNotes').value;
                    document.getElementById('researchNotes').value = currentNotes + processedContent;
                    updateProject();
                };
                reader.readAsText(file);
            });
        }

        function updateProject() {
            currentProject.title = document.getElementById('bookTitle').value;
            currentProject.description = document.getElementById('bookDescription').value;
            currentProject.targetLength = parseInt(document.getElementById('targetLength').value) || 50000;
            currentProject.targetUnit = document.getElementById('targetUnit').value;
            currentProject.researchNotes = document.getElementById('researchNotes').value;
            currentProject.outline = document.getElementById('outlineContent').value;
            
            saveProject();
        }

        function saveProject() {
            localStorage.setItem('nonfictionMuse_project', JSON.stringify(currentProject));
        }

        function loadProject() {
            const saved = localStorage.getItem('nonfictionMuse_project');
            if (saved) {
                currentProject = JSON.parse(saved);
                
                // Populate form fields
                document.getElementById('bookTitle').value = currentProject.title || '';
                document.getElementById('bookDescription').value = currentProject.description || '';
                document.getElementById('targetLength').value = currentProject.targetLength || 50000;
                document.getElementById('targetUnit').value = currentProject.targetUnit || 'words';
                document.getElementById('researchNotes').value = currentProject.researchNotes || '';
                document.getElementById('outlineContent').value = currentProject.outline || '';
            }
        }

        // Start a new project
        function startNewProject() {
            if (confirm('Are you sure you want to start a new project? This will clear all current data.')) {
                // Clear localStorage
                localStorage.removeItem('nonfictionMuse_project');
                
                // Reset project object
                currentProject = {
                    title: '',
                    description: '',
                    targetLength: 50000,
                    targetUnit: 'words',
                    researchNotes: '',
                    outline: '',
                    chapters: []
                };
                
                // Clear all form fields
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookDescription').value = '';
                document.getElementById('targetLength').value = 50000;
                document.getElementById('targetUnit').value = 'words';
                document.getElementById('researchNotes').value = '';
                document.getElementById('outlineContent').value = '';
                
                // Re-render chapters (will show empty state)
                renderChapters();
                
                alert('‚úÖ New project started! All fields have been cleared.');
            }
        }

        // Generate outline using AI
        async function generateOutline() {
            if (!currentProject.title || !currentProject.description) {
                alert('Please enter a book title and description first.');
                return;
            }

            const generateBtn = document.getElementById('generateOutlineBtn');
            generateBtn.textContent = 'Generating Outline...';
            generateBtn.disabled = true;

            try {
                const targetInfo = currentProject.targetUnit === 'pages' 
                    ? `${currentProject.targetLength} pages (approximately ${currentProject.targetLength * 250} words)`
                    : `${currentProject.targetLength} words`;

                const prompt = `You are a professional non-fiction book editor and bestselling author. Create a comprehensive, detailed chapter-by-chapter outline for the following book:

Title: "${currentProject.title}"
Description: "${currentProject.description}"
Target Length: ${targetInfo}
Research Notes: ${currentProject.researchNotes || 'None provided'}

REQUIREMENTS FOR THE OUTLINE:
1. Create a logical, well-structured flow of chapters
2. Each chapter should have a compelling, specific title
3. Provide 3-5 detailed bullet points per chapter explaining what will be covered
4. Include specific examples, case studies, or actionable advice for each chapter
5. Ensure chapters build upon each other logically
6. Make sure the outline would result in approximately ${targetInfo} when fully written
7. Focus on providing genuine value and actionable insights to readers

FORMATTING REQUIREMENTS:
- Use proper title capitalization for all chapter titles
- Write in clear, professional language
- Be specific rather than vague (avoid generic phrases)
- Include practical elements that readers can implement

Please provide a detailed outline with chapter titles and comprehensive descriptions of what each chapter will cover. Make this outline professional and publication-ready.`;

                const response = await fetch('https://nonfiction-muse-backend-u4ml.vercel.app/api/claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (data.content) {
                    currentProject.outline = data.content;
                    document.getElementById('outlineContent').value = data.content;
                    saveProject();
                    
                    console.log('Outline generated successfully');
                } else {
                    throw new Error('No content received from AI service');
                }
            } catch (error) {
                console.error('Error generating outline:', error);
                const outlineContent = document.getElementById('outlineContent').value;
                if (outlineContent && outlineContent.trim().length > 100) {
                    console.log('Outline appears to have been generated despite error');
                } else {
                    alert('Failed to generate outline. Please try again.');
                }
            } finally {
                generateBtn.textContent = 'Generate Outline with AI';
                generateBtn.disabled = false;
            }
        }

        function parseChaptersFromOutline(outlineText) {
            try {
                if (!outlineText) {
                    outlineText = document.getElementById('outlineContent').value;
                }
                
                if (!outlineText.trim()) {
                    alert('Please create an outline first.');
                    return;
                }

                const lines = outlineText.split('\n');
                const chapters = [];
                
                lines.forEach(line => {
                    line = line.trim();
                    if (line.match(/^(Chapter \d+|Ch\s*\d+|\d+\.|##)/i) || 
                        (line.length > 10 && line.length < 80 && !line.includes('.') && line.match(/^[A-Z]/))) {
                        
                        let title = line.replace(/^(Chapter \d+[:.\-\s]*|Ch\s*\d+[:.\-\s]*|\d+\.?\s*|##\s*)/i, '').trim();
                        if (title && title.length > 5) {
                            chapters.push({
                                title: title,
                                content: '',
                                wordCount: 0
                            });
                        }
                    }
                });

                if (chapters.length > 0) {
                    currentProject.chapters = chapters;
                    saveProject();
                    renderChapters();
                    alert(`Successfully parsed ${chapters.length} chapters from the outline!`);
                } else {
                    alert('Could not automatically detect chapters. Please check your outline format.');
                }
            } catch (error) {
                console.error('Error parsing chapters:', error);
                alert('Error parsing chapters from outline. Please try again.');
            }
        }

        function renderChapters() {
            const container = document.getElementById('chaptersContainer');
            
            if (currentProject.chapters.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No chapters yet. Use "Convert Outline to Chapters" to get started.</p>';
                return;
            }

            let html = `
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" id="generateAllBtn" onclick="generateAllChapters()">üöÄ Generate All Chapters</button>
                </div>
                <div style="background: white; border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìñ Chapters Ready for Generation:</h3>
                    
                    <div id="progressContainer" style="display: none; margin-bottom: 20px;">
                        <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <p id="progressText" style="margin-top: 10px; text-align: center; color: #666;"></p>
                    </div>
                    
                    <ol style="margin: 0; padding-left: 20px;">
            `;

            currentProject.chapters.forEach((chapter, index) => {
                const wordCount = chapter.wordCount || 0;
                const status = wordCount > 0 ? `‚úÖ ${wordCount} words` : '‚è≥ Ready to generate';
                html += `<li style="margin-bottom: 8px; color: #555;"><strong>${chapter.title}</strong> <span style="color: #888; font-size: 0.9rem;">(${status})</span></li>`;
            });

            html += `</ol></div>`;
            container.innerHTML = html;
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function updateProgress(current, total, message) {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = message;
        }

        async function generateAllChapters() {
            if (currentProject.chapters.length === 0) {
                alert('Please add some chapters first.');
                return;
            }

            const totalTargetWords = currentProject.targetUnit === 'pages' 
                ? currentProject.targetLength * 250 
                : currentProject.targetLength;
            const wordsPerChapter = Math.round(totalTargetWords / currentProject.chapters.length);

            const totalChapters = currentProject.chapters.length;
            const estimatedTotal = wordsPerChapter * totalChapters;
            
            const proceed = confirm(`Generation Plan:
            
üìä TARGETS:
‚Ä¢ ${totalChapters} chapters detected
‚Ä¢ ~${wordsPerChapter} words per chapter
‚Ä¢ ~${estimatedTotal} total words estimated
‚Ä¢ Your target: ${currentProject.targetLength} ${currentProject.targetUnit}

‚ö†Ô∏è QUALITY STANDARDS:
‚Ä¢ Professional grammar and capitalization
‚Ä¢ Engaging, actionable content
‚Ä¢ Proper structure and flow
‚Ä¢ Publication-ready quality

This will generate all ${totalChapters} chapters. This may take several minutes.

Continue with generation?`);

            if (!proceed) return;

            const generateAllBtn = document.getElementById('generateAllBtn');
            generateAllBtn.textContent = 'Generating All Chapters...';
            generateAllBtn.disabled = true;

            showProgress();
            updateProgress(0, totalChapters, 'Starting chapter generation...');

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < currentProject.chapters.length; i++) {
                const chapter = currentProject.chapters[i];

                try {
                    updateProgress(i, totalChapters, `Generating Chapter ${i + 1} of ${totalChapters}: "${chapter.title}"`);

                    const prompt = `You are a professional non-fiction author and bestselling writer. Write a high-quality, engaging chapter for the book "${currentProject.title}".

CHAPTER DETAILS:
- Chapter Title: "${chapter.title}"
- Target Length: ${wordsPerChapter} words
- Chapter ${i + 1} of ${currentProject.chapters.length}
- Book Description: "${currentProject.description}"
- Book Outline Context: ${currentProject.outline || 'No outline provided'}
- Research Notes: ${currentProject.researchNotes || 'None provided'}

STRICT WRITING REQUIREMENTS:
1. QUALITY STANDARDS:
   - Use perfect grammar, spelling, and punctuation
   - Apply proper capitalization throughout (titles, sentences, proper nouns)
   - Write in clear, engaging, professional prose
   - Maintain consistency in tone and style
   - Use active voice whenever possible

2. CONTENT REQUIREMENTS:
   - Write exactly ${wordsPerChapter} words (¬±50 words acceptable)
   - Provide actionable, valuable insights
   - Include specific examples, case studies, or real-world applications
   - Structure with clear subheadings if appropriate
   - Ensure logical flow and smooth transitions between paragraphs
   - Make content immediately useful to readers

3. STRUCTURE REQUIREMENTS:
   - Start with an engaging opening that hooks the reader
   - Organize content into clear, logical sections
   - Use paragraph breaks for readability (avoid walls of text)
   - End with a strong conclusion or transition to next chapter
   - Include practical takeaways or action items where relevant

4. TONE AND STYLE:
   - Professional but accessible language
   - Conversational tone that engages readers
   - Avoid jargon unless necessary (then explain it)
   - Write for intelligent adults who want practical value
   - Be specific and concrete rather than vague or generic

5. CHAPTER CONTEXT:
   - This is chapter ${i + 1} of ${currentProject.chapters.length} in the book
   - Ensure it fits logically with the overall book structure
   - Build upon concepts from earlier chapters where appropriate

CRITICAL: This chapter will be published in a book, so ensure it meets professional publishing standards. Every sentence should be polished, purposeful, and properly formatted.

Write the complete chapter content now:`;

                    const response = await fetch('https://nonfiction-muse-backend-u4ml.vercel.app/api/claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    const data = await response.json();
                    
                    if (data.content) {
                        currentProject.chapters[i].content = data.content;
                        
                        const wordCount = data.content.split(/\s+/).length;
                        currentProject.chapters[i].wordCount = wordCount;
                        
                        successCount++;
                        updateProgress(i + 1, totalChapters, `‚úÖ Chapter ${i + 1} complete (${wordCount} words)`);
                    } else {
                        throw new Error('No content received');
                    }
                } catch (error) {
                    console.error(`Error generating chapter ${i + 1}:`, error);
                    failCount++;
                    updateProgress(i + 1, totalChapters, `‚ùå Chapter ${i + 1} failed`);
                }

                saveProject();
                renderChapters();

                if (i < currentProject.chapters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            updateProgress(totalChapters, totalChapters, `Generation complete! ‚úÖ ${successCount} chapters, ‚ùå ${failCount} failed`);

            generateAllBtn.textContent = 'Generate All Chapters';
            generateAllBtn.disabled = false;

            setTimeout(() => {
                hideProgress();
            }, 3000);

            const totalWords = currentProject.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0);
            alert(`Generation Complete!\n\n‚úÖ Success: ${successCount} chapters\n‚ùå Failed: ${failCount} chapters\nüìä Total words: ${totalWords}`);
        }

        // Export functions - Copy & Paste method
        function showWordExport() {
            if (currentProject.chapters.length === 0) {
                alert('Please generate some chapters first.');
                return;
            }

            let content = `${currentProject.title}\n\n`;
            if (currentProject.description) {
                content += `${currentProject.description}\n\n`;
            }

            currentProject.chapters.forEach((chapter, index) => {
                if (chapter.content) {
                    if (index > 0) content += '\n\n--- PAGE BREAK ---\n\n';
                    content += `${chapter.title}\n\n${chapter.content}\n\n`;
                }
            });

            showExportModal('Complete Book Content', content, 'Copy this content and paste it into Microsoft Word. Use "--- PAGE BREAK ---" markers to add page breaks between chapters.');
        }

        function showChapterExport() {
            if (currentProject.chapters.length === 0) {
                alert('Please generate some chapters first.');
                return;
            }

            let content = '';
            currentProject.chapters.forEach((chapter, index) => {
                if (chapter.content) {
                    content += `=== CHAPTER ${index + 1}: ${chapter.title} ===\n\n`;
                    content += `${chapter.content}\n\n`;
                    content += `=== END CHAPTER ${index + 1} ===\n\n\n`;
                }
            });

            showExportModal('Individual Chapters', content, 'Copy each chapter section separately and create individual Word documents for each one. Perfect for importing into Atticus!');
        }

        function showExportModal(title, content, instructions) {
            document.getElementById('modalTitle').textContent = title;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">${instructions}</p>
                <div class="copy-content" id="copyContent">${content}</div>
                <button class="copy-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                <p style="margin-top: 10px; font-size: 14px; color: #888;">
                    üí° Tip: After copying, open Microsoft Word, paste (Ctrl+V), format as needed, then save as .docx
                </p>
            `;
            
            document.getElementById('exportModal').style.display = 'block';
        }

        function copyToClipboard() {
            const content = document.getElementById('copyContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('‚úÖ Content copied to clipboard! Now paste it into Microsoft Word.');
            }).catch(() => {
                alert('Please manually select and copy the text above.');
            });
        }

        function closeModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>