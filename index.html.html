<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-fiction Muse</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        // Wait for libraries to load and provide fallback
        let docxReady = false;
        let fileSaverReady = false;
        
        // Check if libraries loaded after page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                docxReady = typeof docx !== 'undefined';
                fileSaverReady = typeof saveAs !== 'undefined';
                console.log('Docx ready:', docxReady);
                console.log('FileSaver ready:', fileSaverReady);
                
                if (!docxReady) {
                    console.warn('Docx library failed to load, will use RTF fallback');
                }
            }, 1000);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .project-setup {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .target-length {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .target-length input {
            flex: 1;
        }

        .target-length select {
            flex: 0 0 120px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .chapters-container {
            margin-top: 20px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .export-section {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-left-color: #4facfe;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 15px 25px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .export-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .export-btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            border: none;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .export-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .export-btn:hover:before {
            left: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .target-length {
                flex-direction: column;
            }
            
            .target-length select {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Non-fiction Muse</h1>
            <p>Your AI-powered book writing companion</p>
        </div>

        <div class="main-content">
            <!-- Project Setup -->
            <div class="section project-setup">
                <h2><span class="section-icon">🎯</span>Project Setup</h2>
                
                <div class="form-group">
                    <label for="bookTitle">Book Title *</label>
                    <input type="text" id="bookTitle" placeholder="Enter your book title..." oninput="updateProject()">
                </div>

                <div class="form-group">
                    <label for="bookDescription">Book Description *</label>
                    <textarea id="bookDescription" placeholder="Describe what your book is about, who it's for, and what value it provides..." oninput="updateProject()"></textarea>
                </div>

                <div class="form-group">
                    <label for="targetLength">Target Length *</label>
                    <div class="target-length">
                        <input type="number" id="targetLength" placeholder="Enter target..." min="1" oninput="updateProject()">
                        <select id="targetUnit" onchange="updateProject()">
                            <option value="words">Words</option>
                            <option value="pages">Pages</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Research Upload -->
            <div class="section">
                <h2><span class="section-icon">📄</span>Research Documents</h2>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <p>📁 Click to upload research documents (PDF, TXT, DOCX)</p>
                    <p><small>Or drag and drop files here</small></p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.docx" style="display: none;" onchange="handleFileUpload(event)">
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="researchNotes">Research Notes</label>
                    <textarea id="researchNotes" placeholder="Add your research notes, key points, references, or any important information for your book..." oninput="updateProject()"></textarea>
                </div>
            </div>

            <!-- Outline Generation -->
            <div class="section">
                <h2><span class="section-icon">📋</span>Book Outline</h2>
                <button class="btn" id="generateOutlineBtn" onclick="generateOutline()">✨ Generate Outline with AI</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="outlineContent">Book Outline</label>
                    <textarea id="outlineContent" placeholder="Your book outline will appear here, or you can write your own..." oninput="updateProject()" style="min-height: 200px;"></textarea>
                </div>

                <button class="btn btn-secondary" onclick="parseChaptersFromOutline()" style="margin-top: 10px;">
                    📚 Convert Outline to Chapters
                </button>
            </div>

            <!-- Chapter Management -->
            <div class="section">
                <h2><span class="section-icon">📖</span>Chapters</h2>

                <div id="chaptersContainer" class="chapters-container">
                    <!-- Chapters will be rendered here -->
                </div>
            </div>

            <!-- Export Section -->
            <div class="section export-section">
                <h2><span class="section-icon">💾</span>Export Manuscript</h2>
                <p><strong>📖 Export Your Manuscript:</strong></p>
                
                <div class="export-buttons">
                    <button class="export-btn export-btn-primary" onclick="exportWordSingle()">
                        📄 Single Document with Chapter Sections
                    </button>
                    
                    <button class="export-btn export-btn-success" onclick="exportWordChapters()">
                        📚 Individual Chapter Files (Recommended for Atticus)
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                    <p><strong>📄 Single Document:</strong> One Word file with proper section breaks between chapters</p>
                    <p><strong>📚 Individual Chapter Files:</strong> Separate Word files for each chapter - perfect for importing into Atticus and other book formatting software</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Export</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global project state
        let currentProject = {
            title: '',
            description: '',
            targetLength: 50000,
            targetUnit: 'words',
            researchNotes: '',
            outline: '',
            chapters: []
        };

        // Load project from localStorage on page load
        window.addEventListener('load', function() {
            loadProject();
            renderChapters();
        });

        // File upload handling
        document.addEventListener('DOMContentLoaded', function() {
            const fileUpload = document.querySelector('.file-upload');
            
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFileUpload({ target: { files } });
            });
        });

        function handleFileUpload(event) {
            const files = event.target.files;
            let processedContent = '';
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processedContent += `\n\n--- ${file.name} ---\n`;
                    processedContent += e.target.result;
                    
                    const currentNotes = document.getElementById('researchNotes').value;
                    document.getElementById('researchNotes').value = currentNotes + processedContent;
                    updateProject();
                };
                reader.readAsText(file);
            });
        }

        function updateProject() {
            currentProject.title = document.getElementById('bookTitle').value;
            currentProject.description = document.getElementById('bookDescription').value;
            currentProject.targetLength = parseInt(document.getElementById('targetLength').value) || 50000;
            currentProject.targetUnit = document.getElementById('targetUnit').value;
            currentProject.researchNotes = document.getElementById('researchNotes').value;
            currentProject.outline = document.getElementById('outlineContent').value;
            
            saveProject();
        }

        function saveProject() {
            localStorage.setItem('nonfictionMuse_project', JSON.stringify(currentProject));
        }

        function loadProject() {
            const saved = localStorage.getItem('nonfictionMuse_project');
            if (saved) {
                currentProject = JSON.parse(saved);
                
                // Populate form fields
                document.getElementById('bookTitle').value = currentProject.title || '';
                document.getElementById('bookDescription').value = currentProject.description || '';
                document.getElementById('targetLength').value = currentProject.targetLength || 50000;
                document.getElementById('targetUnit').value = currentProject.targetUnit || 'words';
                document.getElementById('researchNotes').value = currentProject.researchNotes || '';
                document.getElementById('outlineContent').value = currentProject.outline || '';
            }
        }

        // Generate outline using AI
        async function generateOutline() {
            if (!currentProject.title || !currentProject.description) {
                alert('Please enter a book title and description first.');
                return;
            }

            const generateBtn = document.getElementById('generateOutlineBtn');
            generateBtn.textContent = 'Generating Outline...';
            generateBtn.disabled = true;

            try {
                const targetInfo = currentProject.targetUnit === 'pages' 
                    ? `${currentProject.targetLength} pages (approximately ${currentProject.targetLength * 250} words)`
                    : `${currentProject.targetLength} words`;

                const prompt = `You are a professional non-fiction book editor and bestselling author. Create a comprehensive, detailed chapter-by-chapter outline for the following book:

Title: "${currentProject.title}"
Description: "${currentProject.description}"
Target Length: ${targetInfo}
Research Notes: ${currentProject.researchNotes || 'None provided'}

REQUIREMENTS FOR THE OUTLINE:
1. Create a logical, well-structured flow of chapters
2. Each chapter should have a compelling, specific title
3. Provide 3-5 detailed bullet points per chapter explaining what will be covered
4. Include specific examples, case studies, or actionable advice for each chapter
5. Ensure chapters build upon each other logically
6. Make sure the outline would result in approximately ${targetInfo} when fully written
7. Focus on providing genuine value and actionable insights to readers

FORMATTING REQUIREMENTS:
- Use proper title capitalization for all chapter titles
- Write in clear, professional language
- Be specific rather than vague (avoid generic phrases)
- Include practical elements that readers can implement

Please provide a detailed outline with chapter titles and comprehensive descriptions of what each chapter will cover. Make this outline professional and publication-ready.`;

                const response = await fetch('https://nonfiction-muse-backend-u4ml.vercel.app/api/claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (data.content) {
                    currentProject.outline = data.content;
                    document.getElementById('outlineContent').value = data.content;
                    saveProject();
                    
                    // Try to auto-parse chapters from the outline
                    parseChaptersFromOutline(data.content);
                } else {
                    throw new Error('No content received from AI service');
                }
            } catch (error) {
                console.error('Error generating outline:', error);
                alert('Failed to generate outline. Please try again.');
            } finally {
                generateBtn.textContent = 'Generate Outline with AI';
                generateBtn.disabled = false;
            }
        }

        function parseChaptersFromOutline(outlineText) {
            if (!outlineText) {
                outlineText = document.getElementById('outlineContent').value;
            }
            
            if (!outlineText.trim()) {
                alert('Please create an outline first.');
                return;
            }

            // Simple parsing - look for chapter patterns
            const lines = outlineText.split('\n');
            const chapters = [];
            
            lines.forEach(line => {
                line = line.trim();
                // Look for chapter headings (various formats)
                if (line.match(/^(Chapter \d+|Ch\s*\d+|\d+\.|##)/i) || 
                    (line.length > 10 && line.length < 80 && !line.includes('.') && line.match(/^[A-Z]/))) {
                    
                    // Clean up the chapter title
                    let title = line.replace(/^(Chapter \d+[:.\-\s]*|Ch\s*\d+[:.\-\s]*|\d+\.?\s*|##\s*)/i, '').trim();
                    if (title && title.length > 5) {
                        chapters.push({
                            title: title,
                            content: '',
                            wordCount: 0
                        });
                    }
                }
            });

            if (chapters.length > 0) {
                currentProject.chapters = chapters;
                saveProject();
                renderChapters();
                alert(`Successfully parsed ${chapters.length} chapters from the outline!`);
            } else {
                alert('Could not automatically detect chapters. Please add chapters manually.');
            }
        }

        // Generate all chapters - simplified version
        async function generateAllChapters() {
            if (currentProject.chapters.length === 0) {
                alert('Please add some chapters first.');
                return;
            }

            // Calculate target words per chapter
            const totalTargetWords = currentProject.targetUnit === 'pages' 
                ? currentProject.targetLength * 250 
                : currentProject.targetLength;
            const wordsPerChapter = Math.round(totalTargetWords / currentProject.chapters.length);

            // Show generation plan
            const totalChapters = currentProject.chapters.length;
            const estimatedTotal = wordsPerChapter * totalChapters;
            
            const proceed = confirm(`Generation Plan:
            
📊 TARGETS:
• ${totalChapters} chapters detected
• ~${wordsPerChapter} words per chapter
• ~${estimatedTotal} total words estimated
• Your target: ${currentProject.targetLength} ${currentProject.targetUnit}

⚠️ QUALITY STANDARDS:
• Professional grammar and capitalization
• Engaging, actionable content
• Proper structure and flow
• Publication-ready quality

This will generate all ${totalChapters} chapters. This may take several minutes.

Continue with generation?`);

            if (!proceed) return;

            const generateAllBtn = document.getElementById('generateAllBtn');
            generateAllBtn.textContent = 'Generating All Chapters...';
            generateAllBtn.disabled = true;

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < currentProject.chapters.length; i++) {
                const chapter = currentProject.chapters[i];

                try {
                    generateAllBtn.textContent = `Generating Chapter ${i + 1} of ${currentProject.chapters.length}...`;

                    const prompt = `You are a professional non-fiction author and bestselling writer. Write a high-quality, engaging chapter for the book "${currentProject.title}".

CHAPTER DETAILS:
- Chapter Title: "${chapter.title}"
- Target Length: ${wordsPerChapter} words
- Chapter ${i + 1} of ${currentProject.chapters.length}
- Book Description: "${currentProject.description}"
- Book Outline Context: ${currentProject.outline || 'No outline provided'}
- Research Notes: ${currentProject.researchNotes || 'None provided'}

STRICT WRITING REQUIREMENTS:
1. QUALITY STANDARDS:
   - Use perfect grammar, spelling, and punctuation
   - Apply proper capitalization throughout (titles, sentences, proper nouns)
   - Write in clear, engaging, professional prose
   - Maintain consistency in tone and style
   - Use active voice whenever possible

2. CONTENT REQUIREMENTS:
   - Write exactly ${wordsPerChapter} words (±50 words acceptable)
   - Provide actionable, valuable insights
   - Include specific examples, case studies, or real-world applications
   - Structure with clear subheadings if appropriate
   - Ensure logical flow and smooth transitions between paragraphs
   - Make content immediately useful to readers

3. STRUCTURE REQUIREMENTS:
   - Start with an engaging opening that hooks the reader
   - Organize content into clear, logical sections
   - Use paragraph breaks for readability (avoid walls of text)
   - End with a strong conclusion or transition to next chapter
   - Include practical takeaways or action items where relevant

4. TONE AND STYLE:
   - Professional but accessible language
   - Conversational tone that engages readers
   - Avoid jargon unless necessary (then explain it)
   - Write for intelligent adults who want practical value
   - Be specific and concrete rather than vague or generic

5. CHAPTER CONTEXT:
   - This is chapter ${i + 1} of ${currentProject.chapters.length} in the book
   - Ensure it fits logically with the overall book structure
   - Build upon concepts from earlier chapters where appropriate

CRITICAL: This chapter will be published in a book, so ensure it meets professional publishing standards. Every sentence should be polished, purposeful, and properly formatted.

Write the complete chapter content now:`;

                    const response = await fetch('https://nonfiction-muse-backend-u4ml.vercel.app/api/claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    const data = await response.json();
                    
                    if (data.content) {
                        currentProject.chapters[i].content = data.content;
                        
                        // Update word count
                        const wordCount = data.content.split(/\s+/).length;
                        currentProject.chapters[i].wordCount = wordCount;
                        
                        successCount++;
                    } else {
                        throw new Error('No content received');
                    }
                } catch (error) {
                    console.error(`Error generating chapter ${i + 1}:`, error);
                    failCount++;
                }

                // Save progress after each chapter
                saveProject();
                renderChapters();

                // Small delay between API calls
                if (i < currentProject.chapters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            generateAllBtn.textContent = 'Generate All Chapters';
            generateAllBtn.disabled = false;

            const totalWords = currentProject.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0);
            alert(`Generation Complete!\n\n✅ Success: ${successCount} chapters\n❌ Failed: ${failCount} chapters\n📊 Total words: ${totalWords}`);
        }

        // Helper function for file downloads
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Word export functionality - more reliable approach
        async function exportWordSingle() {
            try {
                // Try proper docx first, then fallback to compatible RTF
                await createDocxFile(false);
            } catch (error) {
                console.error('DOCX creation failed, using RTF fallback:', error);
                createRTFFile(false);
            }
        }

        // Export individual chapter files
        async function exportWordChapters() {
            try {
                // Try proper docx first, then fallback to compatible RTF
                await createDocxFile(true);
            } catch (error) {
                console.error('DOCX creation failed, using RTF fallback:', error);
                createRTFFile(true);
            }
        }

        // Create proper DOCX files
        async function createDocxFile(isChapters) {
            // Wait for libraries to load
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (typeof docx === 'undefined') {
                throw new Error('DOCX library not available');
            }

            const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel } = docx;

            if (isChapters) {
                // Individual chapter files
                let downloadCount = 0;
                
                for (let i = 0; i < currentProject.chapters.length; i++) {
                    const chapter = currentProject.chapters[i];
                    const children = [];
                    
                    // Chapter title
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: chapter.title,
                                    bold: true,
                                    size: 28
                                })
                            ],
                            spacing: { after: 300 }
                        })
                    );
                    
                    // Chapter content
                    const paragraphs = chapter.content.split('\n\n');
                    paragraphs.forEach(para => {
                        if (para.trim()) {
                            children.push(
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: para.trim(),
                                            size: 22
                                        })
                                    ],
                                    spacing: { after: 200 }
                                })
                            );
                        }
                    });
                    
                    const doc = new Document({
                        sections: [{
                            children: children
                        }]
                    });
                    
                    const blob = await Packer.toBlob(doc);
                    const chapterNumber = (i + 1).toString().padStart(2, '0');
                    const filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_chapter_${chapterNumber}.docx`;
                    
                    downloadFile(blob, filename);
                    downloadCount++;
                    
                    // Small delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                showExportModal('Individual Chapter Files (.docx)', `Successfully downloaded ${downloadCount} chapter files as proper Word documents!`);
            } else {
                // Single document
                const children = [];
                
                // Title
                children.push(
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: currentProject.title,
                                bold: true,
                                size: 32
                            })
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    })
                );
                
                // Description
                if (currentProject.description) {
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: currentProject.description,
                                    size: 24
                                })
                            ],
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 600 }
                        })
                    );
                }
                
                // Chapters
                currentProject.chapters.forEach((chapter, index) => {
                    if (index > 0) {
                        children.push(
                            new Paragraph({
                                children: [],
                                pageBreakBefore: true
                            })
                        );
                    }
                    
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: chapter.title,
                                    bold: true,
                                    size: 28
                                })
                            ],
                            heading: HeadingLevel.HEADING_1,
                            spacing: { after: 300 }
                        })
                    );
                    
                    const paragraphs = chapter.content.split('\n\n');
                    paragraphs.forEach(para => {
                        if (para.trim()) {
                            children.push(
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: para.trim(),
                                            size: 22
                                        })
                                    ],
                                    spacing: { after: 200 }
                                })
                            );
                        }
                    });
                });
                
                const doc = new Document({
                    sections: [{
                        children: children
                    }]
                });
                
                const blob = await Packer.toBlob(doc);
                const filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.docx`;
                
                downloadFile(blob, filename);
                showExportModal('Word Document (.docx)', 'Successfully downloaded as proper Word document!');
            }
        }

        // Create RTF files (proper format for Word compatibility)
        function createRTFFile(isChapters) {
            if (isChapters) {
                // Individual chapter files as RTF
                let downloadCount = 0;
                
                currentProject.chapters.forEach((chapter, index) => {
                    let rtf = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0\\fswiss\\fcharset0 Arial;}}';
                    rtf += '\\f0\\fs24';
                    
                    // Chapter title
                    rtf += `\\b\\fs32 ${escapeRTF(chapter.title)}\\b0\\fs24\\par\\par`;
                    
                    // Chapter content
                    const paragraphs = chapter.content.split('\n\n');
                    paragraphs.forEach(para => {
                        if (para.trim()) {
                            rtf += `${escapeRTF(para.trim())}\\par\\par`;
                        }
                    });
                    
                    rtf += '}';
                    
                    const blob = new Blob([rtf], { type: 'application/rtf' });
                    const chapterNumber = (index + 1).toString().padStart(2, '0');
                    const filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_chapter_${chapterNumber}.rtf`;
                    
                    downloadFile(blob, filename);
                    downloadCount++;
                });
                
                showExportModal('Individual Chapter Files (.rtf)', `Downloaded ${downloadCount} chapter files as RTF format. These will open perfectly in Word and import into Atticus!`);
            } else {
                // Single document as RTF
                let rtf = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0\\fswiss\\fcharset0 Arial;}}';
                rtf += '\\f0\\fs24';
                
                // Title (centered)
                rtf += `\\qc\\b\\fs36 ${escapeRTF(currentProject.title)}\\b0\\par\\par`;
                
                // Description (centered)
                if (currentProject.description) {
                    rtf += `\\fs28 ${escapeRTF(currentProject.description)}\\par\\par`;
                }
                
                // Reset to left alignment
                rtf += '\\ql\\fs24';
                
                // Chapters
                currentProject.chapters.forEach((chapter, index) => {
                    if (index > 0) {
                        rtf += '\\page'; // Page break
                    }
                    
                    // Chapter title
                    rtf += `\\b\\fs32 ${escapeRTF(chapter.title)}\\b0\\fs24\\par\\par`;
                    
                    // Chapter content
                    const paragraphs = chapter.content.split('\n\n');
                    paragraphs.forEach(para => {
                        if (para.trim()) {
                            rtf += `${escapeRTF(para.trim())}\\par\\par`;
                        }
                    });
                });
                
                rtf += '}';
                
                const blob = new Blob([rtf], { type: 'application/rtf' });
                const filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.rtf`;
                
                downloadFile(blob, filename);
                showExportModal('Word Document (.rtf)', 'Downloaded as RTF format. This will open perfectly in Word and import into Atticus!');
            }
        }

        // Helper function to escape RTF special characters
        function escapeRTF(text) {
            return text.replace(/\\/g, '\\\\')
                      .replace(/\{/g, '\\{')
                      .replace(/\}/g, '\\}')
                      .replace(/\n/g, '\\par ')
                      .replace(/\r/g, '');
        }

        // Modal functions
        function showExportModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="success-message">
                    <span style="font-size: 24px;">✅</span>
                    <span>${content}</span>
                </div>
            `;
            
            document.getElementById('exportModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>